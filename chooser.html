<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horse Chooser - RDR2 Companion</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rye&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="components.css">
    <style>
        .chooser-container {
            max-width: 700px;
            margin: 0 auto;
        }

        .question-card {
            padding: 30px;
        }

        .question-card h2 {
            font-family: 'Rye', cursive;
            color: var(--text-cream);
            margin-bottom: 10px;
            font-size: 1.3rem;
        }

        .question-hint {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: 15px;
            font-style: italic;
        }

        .question-number {
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .freeform-textarea {
            width: 100%;
            min-height: 80px;
            padding: 15px;
            background: var(--bg-dark);
            border: 1px solid var(--border-medium);
            border-radius: 4px;
            color: var(--text-cream);
            font-size: 1rem;
            font-family: 'Crimson Text', Georgia, serif;
            resize: vertical;
        }

        .freeform-textarea:focus {
            outline: none;
            border-color: var(--red-primary);
        }

        .freeform-textarea::placeholder {
            color: var(--text-muted);
            font-style: italic;
        }

        .example-chips {
            margin-top: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .example-chip {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            padding: 6px 14px;
            border-radius: 4px;
            font-size: 0.85rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
        }

        .example-chip:hover {
            border-color: var(--red-primary);
            color: var(--text-cream);
        }

        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 25px;
        }

        .nav-btn {
            background: var(--bg-elevated);
            border: 1px solid var(--border-medium);
            color: var(--text-cream);
            padding: 12px 25px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            font-family: 'Crimson Text', Georgia, serif;
            transition: all 0.2s;
        }

        .nav-btn:hover {
            border-color: var(--red-primary);
        }

        .nav-btn.primary {
            background: var(--red-primary);
            color: var(--text-cream);
            border: none;
            font-weight: 600;
            font-family: 'Rye', cursive;
            letter-spacing: 1px;
        }

        .nav-btn.primary:hover {
            background: #d42945;
            box-shadow: 0 0 20px var(--red-glow);
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .progress-bar {
            background: var(--bg-dark);
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            background: var(--red-primary);
            height: 100%;
            transition: width 0.3s ease;
        }

        .skip-link {
            display: block;
            text-align: center;
            margin-top: 12px;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.85rem;
            font-style: italic;
        }

        .skip-link:hover {
            color: var(--rust);
        }

        /* Results */
        .results-container {
            display: none;
        }

        .results-container.show {
            display: block;
        }

        .ai-thinking {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            padding: 60px 40px;
            text-align: center;
        }

        .ai-thinking .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-subtle);
            border-top-color: var(--red-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .ai-thinking p {
            color: var(--text-muted);
            max-width: 300px;
            font-style: italic;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .your-answers h3 {
            font-family: 'Rye', cursive;
            color: var(--text-cream);
            margin-bottom: 15px;
            font-size: 1rem;
        }

        .answer-item {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            font-size: 1rem;
        }

        .answer-label {
            color: var(--text-muted);
            min-width: 100px;
        }

        .answer-value {
            color: var(--text-cream);
            font-style: italic;
        }

        .horse-name {
            font-family: 'Rye', cursive;
            color: var(--text-cream);
            font-size: 1.4rem;
            margin-bottom: 5px;
        }

        .horse-coat {
            color: var(--text-muted);
            font-style: italic;
        }

        .stat-values {
            font-size: 1rem;
        }

        .stat-base {
            color: var(--text-muted);
        }

        .stat-max {
            color: var(--red-primary);
            font-weight: bold;
            font-family: 'Rye', cursive;
        }

        .horse-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }

        .detail-item {
            display: flex;
            gap: 8px;
            font-size: 1rem;
        }

        .detail-label {
            color: var(--text-muted);
        }

        .detail-value {
            color: var(--text-cream);
        }

        .ai-reason {
            background: var(--bg-dark);
            padding: 14px 18px;
            border-radius: 4px;
            border-left: 3px solid var(--rust);
            margin-top: 15px;
            font-size: 1.05rem;
            line-height: 1.6;
            color: var(--text-muted);
            font-style: italic;
        }

        .ai-reason strong {
            color: var(--rust);
            font-style: normal;
        }

        .community-note {
            margin-top: 10px;
            font-size: 0.95rem;
            line-height: 1.5;
            color: var(--text-muted);
            padding: 12px;
            background: var(--bg-dark);
            border-radius: 4px;
            border: 1px solid var(--border-subtle);
        }

        .alt-acquisition {
            margin-top: 10px;
            padding: 10px 12px;
            background: var(--bg-elevated);
            border-radius: 4px;
            font-size: 0.95rem;
        }

        .alt-method {
            display: block;
            margin-top: 5px;
            color: var(--text-muted);
            font-style: italic;
        }

        .community-note strong {
            color: var(--rust);
        }

        .restart-btn {
            display: block;
            width: 100%;
            margin-top: 30px;
            padding: 15px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-medium);
            color: var(--text-cream);
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            font-family: 'Crimson Text', Georgia, serif;
        }

        .restart-btn:hover {
            border-color: var(--red-primary);
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        /* .back-link styles moved to components.css */

        .error-message {
            background: var(--red-dark);
            color: var(--text-cream);
            padding: 20px;
            border-radius: 4px;
            text-align: center;
            border: 1px solid var(--red-primary);
        }

        /* Responsive for result cards with images */
        @media (max-width: 600px) {
            .result-header {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }

            .result-header .horse-image-large {
                width: 150px;
                height: 150px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .horse-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <!-- Supabase Auth -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="utils.js"></script>
    <!-- Vercel Analytics -->
    <script defer src="/_vercel/insights/script.js"></script>
    <script src="components.js"></script>
</head>
<body>
    <div class="container chooser-container">
        <script>document.write(Components.header({backHref: "horses.html", backText: "Back to Horses", title: "RDR2 Horse Chooser", subtitle: "Tell us what you're looking for in your own words"}))</script>

        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>

        <main id="questionContainer">
            <!-- Questions will be injected here -->
        </main>

        <div class="results-container" id="resultsContainer">
            <div id="resultsContent"></div>
            <button class="restart-btn" onclick="restart()">Start Over</button>
        </div>
    </div>

    <script>
        // Auth functions provided by utils.js (getAuthToken, signInWithGoogle)

        let horseData = null;
        let currentQuestion = 0;
        let answers = {};

        // Helper to get first acquisition (handles both array and object)
        function getAcquisition(horse) {
            return Array.isArray(horse.acquisition) ? horse.acquisition[0] : horse.acquisition;
        }

        // Render acquisition notes and alternate acquisition methods
        function renderAcquisitionNotes(horse) {
            const acqs = Array.isArray(horse.acquisition) ? horse.acquisition : [horse.acquisition];
            let html = '';

            // Show notes from first acquisition
            if (acqs[0].notes) {
                html += `<p style="color: var(--text-muted); font-size: 0.95rem;"><strong>Note:</strong> ${acqs[0].notes}</p>`;
            }

            // Show alternate acquisition methods
            if (acqs.length > 1) {
                html += `<div class="alt-acquisition">
                    <strong style="color: var(--rust);">Also available:</strong>
                    ${acqs.slice(1).map(acq => {
                        const method = acq.method === 'wild' ? 'Wild' : acq.method === 'stable' ? 'Stable' : acq.method;
                        return `<span class="alt-method">${method} at ${acq.location} (${acq.chapter})</span>`;
                    }).join('')}
                </div>`;
            }

            return html;
        }

        const questions = [
            {
                id: 'progress',
                question: 'Where are you in the story?',
                hint: 'This helps us know which horses are available to you.',
                placeholder: 'e.g., "Just started Chapter 2" or "Almost done with the main story"',
                examples: [
                    'Early Chapter 2',
                    'Chapter 3, just got to Rhodes',
                    'Chapter 4 in Saint Denis',
                    'Finished the epilogue'
                ]
            },
            {
                id: 'budget',
                question: 'What\'s your budget situation?',
                hint: 'Are you flush with cash or pinching pennies?',
                placeholder: 'e.g., "I\'ve got about $500" or "Looking for something free"',
                examples: [
                    'Broke, need something free',
                    'Got about $200 to spend',
                    'Money\'s not an issue',
                    'Under $500 ideally'
                ]
            },
            {
                id: 'stats',
                question: 'How should I prioritize Speed, Stamina, Health, and Acceleration?',
                hint: 'What matters most to you in a horse?',
                placeholder: 'e.g., "Speed is most important, then health" or "I want a balanced horse"',
                examples: [
                    'Speed above all else',
                    'Health first, I hate when my horse dies',
                    'Balanced, good at everything',
                    'Stamina for long rides'
                ]
            },
            {
                id: 'use',
                question: 'What will you mainly use this horse for?',
                hint: 'Combat? Exploration? Racing? Running from the law?',
                placeholder: 'e.g., "Lots of combat and hunting" or "Just exploring the world"',
                examples: [
                    'Combat and bounty hunting',
                    'Exploring and hunting',
                    'Outrunning lawmen',
                    'A bit of everything'
                ]
            },
            {
                id: 'temperament',
                question: 'How important is temperament to you?',
                hint: 'Some players hate getting bucked off near predators. Note: Temperament differences between breeds are debated.',
                placeholder: 'e.g., "I need a horse that won\'t throw me off near wolves"',
                examples: [
                    'Don\'t care, just want good stats',
                    'Very important, hate getting bucked',
                    'Would prefer a calmer horse',
                    'I\'ll bond with whatever I get'
                ]
            },
            {
                id: 'vibe',
                question: 'Anything else? What\'s the vibe you\'re going for?',
                hint: 'Describe your ideal horse in your own words. Looks, personality, feeling...',
                placeholder: 'e.g., "A majestic white horse fit for a hero" or "Something rugged and tough"',
                examples: [
                    'Badass outlaw energy',
                    'Majestic and beautiful',
                    'Rugged and reliable partner',
                    'Fast and nimble escape artist',
                    'Big intimidating war horse'
                ],
                optional: true
            }
        ];

        // Load horse data
        async function loadData() {
            const response = await fetch('horses.json');
            horseData = await response.json();
            renderQuestion();
        }

        function renderQuestion() {
            const container = document.getElementById('questionContainer');
            const q = questions[currentQuestion];
            const progress = ((currentQuestion) / questions.length) * 100;
            document.getElementById('progressFill').style.width = `${progress}%`;

            container.innerHTML = `
                <div class="question-card">
                    <div class="question-number">Question ${currentQuestion + 1} of ${questions.length}</div>
                    <h2>${q.question}</h2>
                    <p class="question-hint">${q.hint}</p>
                    <textarea
                        class="freeform-textarea"
                        id="answerInput"
                        placeholder="${q.placeholder}"
                        onkeyup="updateAnswer()"
                    >${answers[q.id] || ''}</textarea>
                    <div class="example-chips">
                        ${q.examples.map(ex => `
                            <span class="example-chip" onclick="setExample('${ex.replace(/'/g, "\\'")}')">${ex}</span>
                        `).join('')}
                    </div>
                    <div class="nav-buttons">
                        <button class="nav-btn" onclick="prevQuestion()" ${currentQuestion === 0 ? 'disabled' : ''}>
                            ← Back
                        </button>
                        <button class="nav-btn primary" onclick="nextQuestion()" id="nextBtn">
                            ${currentQuestion === questions.length - 1 ? 'Find My Horse →' : 'Next →'}
                        </button>
                    </div>
                    ${q.optional ? '<span class="skip-link" onclick="skipAndFinish()">Skip and find my horse</span>' : ''}
                </div>
            `;
        }

        function setExample(text) {
            document.getElementById('answerInput').value = text;
            answers[questions[currentQuestion].id] = text;
        }

        function updateAnswer() {
            answers[questions[currentQuestion].id] = document.getElementById('answerInput').value;
        }

        function prevQuestion() {
            if (currentQuestion > 0) {
                currentQuestion--;
                renderQuestion();
            }
        }

        function nextQuestion() {
            updateAnswer();
            if (currentQuestion < questions.length - 1) {
                currentQuestion++;
                renderQuestion();
            } else {
                showResults();
            }
        }

        function skipAndFinish() {
            showResults();
        }

        async function showResults() {
            document.getElementById('questionContainer').style.display = 'none';
            document.getElementById('resultsContainer').classList.add('show');
            document.getElementById('progressFill').style.width = '100%';

            document.getElementById('resultsContent').innerHTML = `
                <div class="ai-thinking">
                    <div class="spinner"></div>
                    <p>Analyzing your preferences and finding the perfect horses for you...</p>
                </div>
            `;

            try {
                const result = await getAIRecommendations();
                renderResults(result);
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('resultsContent').innerHTML = `
                    <div class="error-message">
                        <p>Sorry, there was an error getting recommendations.</p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">${error.message}</p>
                    </div>
                `;
            }
        }

        async function getAIRecommendations() {
            // Check auth first
            const token = await getAuthToken();
            if (!token) {
                throw new Error('Please sign in to get personalized recommendations. <a href="#" onclick="signInWithGoogle(); return false;" style="color: var(--rust);">Sign in with Google</a>');
            }

            const prompt = `You are an RDR2 horse expert. Recommend 3 horses based on the player's preferences.

Player's answers:
- Story Progress: ${answers.progress || 'Not specified'}
- Budget: ${answers.budget || 'Not specified'}
- Stat Priorities: ${answers.stats || 'Not specified'}
- Main Use: ${answers.use || 'Not specified'}
- Temperament: ${answers.temperament || 'Not specified'}
- Vibe: ${answers.vibe || 'Not specified'}

Horse database:
${JSON.stringify(horseData.horses, null, 2)}

CRITICAL: Each horse has an "acquisition.chapter" field (e.g., "Chapter 2+", "Chapter 4+", "Epilogue 1+").
- "Chapter 2+" means available from Chapter 2 onward
- "Chapter 4+" means NOT available until Chapter 4
- "Epilogue 1+" means Epilogue only (Blackwater/Tumbleweed - New Austin is blocked until then)

If the player says they're in Chapter 2, ONLY recommend horses with "Chapter 2+" availability.
If in Chapter 3, recommend "Chapter 2+" or "Chapter 3+" horses.
If in Chapter 4+, they can get most horses except Epilogue-only ones.

FILTER BY THE CHAPTER FIELD. Do not recommend a "Chapter 4+" horse to a Chapter 2 player.

Return your response as JSON in this exact format:
{
    "recommendations": [
        {
            "breed": "Horse Breed",
            "coat": "Coat Color",
            "reason": "2-3 sentences explaining why this horse matches their specific preferences"
        }
    ]
}

Only return the JSON, no other text.`;

            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    system: prompt,
                    messages: [{ role: 'user', content: 'Find me the best horses based on my preferences above.' }]
                })
            });

            if (!response.ok) {
                const err = await response.json();
                if (response.status === 401) {
                    throw new Error('Please sign in to get recommendations. <a href="#" onclick="signInWithGoogle(); return false;" style="color: var(--rust);">Sign in with Google</a>');
                }
                if (response.status === 429) {
                    throw new Error(err.message || 'Daily limit reached. Try again tomorrow!');
                }
                throw new Error(err.message || err.error || 'API request failed');
            }

            const data = await response.json();
            const aiText = data.content[0].text.trim();

            // Parse JSON from response
            let parsed;
            try {
                parsed = JSON.parse(aiText);
            } catch (e) {
                const match = aiText.match(/\{[\s\S]*\}/);
                if (match) {
                    parsed = JSON.parse(match[0]);
                } else {
                    throw new Error('Could not parse AI response');
                }
            }

            return parsed;
        }

        function renderResults(result) {
            const container = document.getElementById('resultsContent');

            if (!result.recommendations || result.recommendations.length === 0) {
                container.innerHTML = `
                    <div class="no-results">
                        <h3>No horses match your criteria</h3>
                        <p>Try adjusting your requirements.</p>
                    </div>
                `;
                return;
            }

            // Build answers summary
            const answersHtml = `
                <div class="your-answers">
                    <h3>Your Preferences</h3>
                    ${answers.progress ? `<div class="answer-item"><span class="answer-label">Progress:</span><span class="answer-value">${answers.progress}</span></div>` : ''}
                    ${answers.budget ? `<div class="answer-item"><span class="answer-label">Budget:</span><span class="answer-value">${answers.budget}</span></div>` : ''}
                    ${answers.stats ? `<div class="answer-item"><span class="answer-label">Stats:</span><span class="answer-value">${answers.stats}</span></div>` : ''}
                    ${answers.use ? `<div class="answer-item"><span class="answer-label">Use:</span><span class="answer-value">${answers.use}</span></div>` : ''}
                    ${answers.temperament ? `<div class="answer-item"><span class="answer-label">Temperament:</span><span class="answer-value">${answers.temperament}</span></div>` : ''}
                    ${answers.vibe ? `<div class="answer-item"><span class="answer-label">Vibe:</span><span class="answer-value">${answers.vibe}</span></div>` : ''}
                </div>
            `;

            // Build horse cards
            const horsesHtml = result.recommendations.map((rec, i) => {
                // Find horse data
                const horse = horseData.horses.find(h =>
                    h.breed.toLowerCase() === rec.breed.toLowerCase() &&
                    h.coat.toLowerCase() === rec.coat.toLowerCase()
                );

                if (!horse) {
                    return `
                        <div class="result-card">
                            <div class="horse-name">${rec.breed} - ${rec.coat}</div>
                            <div class="ai-reason"><strong>Why:</strong> ${rec.reason}</div>
                        </div>
                    `;
                }

                const horseLink = `horse.html?breed=${encodeURIComponent(horse.breed)}&coat=${encodeURIComponent(horse.coat)}`;

                return `
                    <div class="result-card ${i === 0 ? 'rank-1' : ''}">
                        <div class="result-header">
                            ${horse.image ? `<a href="${horseLink}" class="horse-image-link"><img src="${horse.image}" alt="${horse.breed} ${horse.coat}" class="horse-image-large" onerror="this.style.display='none'"></a>` : ''}
                            <div style="flex: 1;">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                    <div>
                                        <a href="${horseLink}" class="horse-name-link"><div class="horse-name">${horse.breed}</div></a>
                                        <div class="horse-coat">${horse.coat} • ${horse.category}</div>
                                    </div>
                                    <div class="rank-badge rank-${i + 1}">#${i + 1}</div>
                                </div>
                                <div class="ai-reason" style="margin-top: 10px;">
                                    <strong>Why this horse:</strong> ${rec.reason}
                                </div>
                            </div>
                        </div>

                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-label">Health</div>
                                <div class="stat-values">
                                    <span class="stat-base">${horse.baseStats.health}</span> →
                                    <span class="stat-max">${horse.maxStats.health}</span>
                                </div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Stamina</div>
                                <div class="stat-values">
                                    <span class="stat-base">${horse.baseStats.stamina}</span> →
                                    <span class="stat-max">${horse.maxStats.stamina}</span>
                                </div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Speed</div>
                                <div class="stat-values">
                                    <span class="stat-base">${horse.baseStats.speed}</span> →
                                    <span class="stat-max">${horse.maxStats.speed}</span>
                                </div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Accel</div>
                                <div class="stat-values">
                                    <span class="stat-base">${horse.baseStats.acceleration}</span> →
                                    <span class="stat-max">${horse.maxStats.acceleration}</span>
                                </div>
                            </div>
                        </div>

                        <div class="horse-details">
                            <div class="detail-item">
                                <span class="detail-label">Handling:</span>
                                <span class="detail-value">${horse.handling}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Price:</span>
                                <span class="detail-value">${horse.price ? '$' + horse.price : 'Free'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Location:</span>
                                <span class="detail-value">${getAcquisition(horse).location}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Available:</span>
                                <span class="detail-value">${getAcquisition(horse).chapter}</span>
                            </div>
                        </div>

                        ${renderAcquisitionNotes(horse)}

                        <div class="community-note">
                            <strong>Community says:</strong> ${horse.communityNotes}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `
                <h2 style="color: var(--accent); text-align: center; margin-bottom: 25px;">Your Top 3 Recommendations</h2>
                ${answersHtml}
                ${horsesHtml}
            `;
        }

        function restart() {
            currentQuestion = 0;
            answers = {};
            document.getElementById('questionContainer').style.display = 'block';
            document.getElementById('resultsContainer').classList.remove('show');
            renderQuestion();
        }

        // Initialize
        loadData();
    </script>
</body>
</html>
