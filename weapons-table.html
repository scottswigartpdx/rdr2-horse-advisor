<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Weapons - RDR2 Companion</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rye&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        .table-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .back-link {
            display: inline-block;
            color: var(--rust);
            text-decoration: none;
            margin-bottom: 20px;
            font-size: 1rem;
        }

        .back-link:hover {
            color: var(--red-primary);
            text-decoration: underline;
        }

        .page-title {
            font-family: 'Chinese Rocks', 'Rye', cursive;
            color: var(--text-cream);
            font-size: 2rem;
            margin-bottom: 20px;
            text-align: center;
            letter-spacing: 3px;
        }

        .search-container {
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px;
            font-size: 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border-medium);
            border-radius: 6px;
            color: var(--text-cream);
            font-family: 'Crimson Text', serif;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--rust);
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        .results-count {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .weapon-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-card);
            border-radius: 8px;
            overflow: hidden;
        }

        .weapon-table th {
            background: var(--bg-elevated);
            color: var(--rust);
            font-family: 'Rye', cursive;
            font-size: 0.85rem;
            padding: 12px 10px;
            text-align: left;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
            border-bottom: 2px solid var(--border-medium);
        }

        .weapon-table th:hover {
            background: var(--bg-dark);
            color: var(--red-primary);
        }

        .weapon-table th.sorted-asc::after {
            content: ' ▲';
            font-size: 0.7rem;
        }

        .weapon-table th.sorted-desc::after {
            content: ' ▼';
            font-size: 0.7rem;
        }

        .weapon-table td {
            padding: 10px;
            border-bottom: 1px solid var(--border-subtle);
            color: var(--text-cream);
            font-size: 0.95rem;
        }

        .weapon-table tr:hover {
            background: var(--bg-elevated);
        }

        .weapon-table tr:last-child td {
            border-bottom: none;
        }

        .weapon-link {
            color: var(--rust);
            text-decoration: none;
            font-weight: 600;
        }

        .weapon-link:hover {
            color: var(--red-primary);
            text-decoration: underline;
        }

        .stat-cell {
            text-align: center;
            font-family: 'Rye', cursive;
        }

        .stat-base {
            color: var(--text-muted);
        }

        .stat-max {
            color: var(--red-primary);
        }

        .category-badge {
            display: inline-block;
            background: var(--bg-dark);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .price-cell {
            color: var(--text-cream);
        }

        .price-free {
            color: var(--text-muted);
            font-style: italic;
        }

        .chapter-cell {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .dual-wield-badge {
            display: inline-block;
            background: var(--rust);
            color: var(--text-cream);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        @media (max-width: 900px) {
            .weapon-table {
                font-size: 0.85rem;
            }

            .weapon-table th,
            .weapon-table td {
                padding: 8px 6px;
            }

            /* Mobile: horizontal scroll with sticky first column */
            .table-outer-wrapper {
                position: relative;
            }

            .table-scroll-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            /* Fade shadow on right edge to indicate more content */
            .table-outer-wrapper::after {
                content: '';
                position: absolute;
                right: 0;
                top: 0;
                bottom: 0;
                width: 30px;
                background: linear-gradient(to right, transparent, var(--bg-dark));
                pointer-events: none;
                z-index: 10;
                opacity: 1;
                transition: opacity 0.2s;
            }

            /* Hide shadow when scrolled to end */
            .table-outer-wrapper.scrolled-end::after {
                opacity: 0;
            }

            .weapon-table {
                min-width: 900px;
                border-collapse: separate;
                border-spacing: 0;
                overflow: visible;
                border-radius: 0;
            }

            /* Sticky first column */
            .weapon-table th:first-child,
            .weapon-table td:first-child {
                position: sticky;
                left: 0;
                z-index: 2;
                background: var(--bg-elevated);
            }

            .weapon-table td:first-child {
                background: var(--bg-card);
            }

            .weapon-table tr:hover td:first-child {
                background: var(--bg-elevated);
            }
        }
    </style>
    <!-- Vercel Analytics -->
    <script defer src="/_vercel/insights/script.js"></script>
</head>
<body>
    <div class="container table-container">
        <header>
            <a href="weapons.html" class="back-link">&larr; Back to Weapons</a>
            <h1 class="page-title">All Weapons</h1>
        </header>

        <main>
            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" placeholder="Search by name, category, location..." autofocus>
            </div>

            <div id="resultsCount" class="results-count"></div>

            <div class="table-outer-wrapper">
                <div class="table-scroll-wrapper" id="tableScrollWrapper">
                    <table class="weapon-table" id="weaponTable">
                    <thead>
                        <tr>
                            <th data-sort="name">Weapon</th>
                            <th data-sort="category">Category</th>
                            <th data-sort="damage" class="stat-cell">Damage</th>
                            <th data-sort="range" class="stat-cell">Range</th>
                            <th data-sort="fireRate" class="stat-cell">Fire Rate</th>
                            <th data-sort="accuracy" class="stat-cell">Accuracy</th>
                            <th data-sort="reload" class="stat-cell">Reload</th>
                            <th data-sort="price">Price</th>
                            <th data-sort="chapter">Available</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="9" class="no-results">Loading weapons...</td>
                        </tr>
                    </tbody>
                    </table>
                </div>
            </div>
        </main>

        <footer>
            <p>Data sourced from the RDR2 community. Not affiliated with Rockstar Games.</p>
        </footer>
    </div>

    <script>
        let weaponData = [];
        let currentSort = { column: 'name', direction: 'asc' };

        // Helper to get first acquisition (handles both array and object)
        function getAcquisition(weapon) {
            return Array.isArray(weapon.acquisition) ? weapon.acquisition[0] : weapon.acquisition;
        }

        async function loadWeapons() {
            try {
                const response = await fetch('weapons.json');
                const data = await response.json();
                weaponData = data.weapons;
                renderTable(weaponData);
                updateResultsCount(weaponData.length);
            } catch (error) {
                console.error('Failed to load weapons:', error);
                document.getElementById('tableBody').innerHTML =
                    '<tr><td colspan="9" class="no-results">Failed to load weapon data</td></tr>';
            }
        }

        function renderTable(weapons) {
            const tbody = document.getElementById('tableBody');

            if (weapons.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="no-results">No weapons match your search</td></tr>';
                return;
            }

            tbody.innerHTML = weapons.map(weapon => {
                const acq = getAcquisition(weapon);
                const dualBadge = weapon.canDualWield ? '<span class="dual-wield-badge">Dual</span>' : '';
                const base = weapon.baseStats || {};
                const max = weapon.maxStats || base;

                // Helper to format stat with arrow if upgradeable
                const formatStat = (baseStat, maxStat) => {
                    if (baseStat === undefined || baseStat === null) return '—';
                    if (maxStat === undefined || maxStat === null || baseStat === maxStat) {
                        return `<span class="stat-max">${baseStat.toFixed(1)}</span>`;
                    }
                    return `<span class="stat-base">${baseStat.toFixed(1)}</span>→<span class="stat-max">${maxStat.toFixed(1)}</span>`;
                };

                return `
                <tr>
                    <td>
                        <a href="weapon.html?name=${encodeURIComponent(weapon.name)}" class="weapon-link">${weapon.name}</a>
                        ${dualBadge}
                    </td>
                    <td><span class="category-badge">${weapon.category}</span></td>
                    <td class="stat-cell">${formatStat(base.damage, max.damage)}</td>
                    <td class="stat-cell">${formatStat(base.range, max.range)}</td>
                    <td class="stat-cell">${formatStat(base.fireRate, max.fireRate)}</td>
                    <td class="stat-cell">${formatStat(base.accuracy, max.accuracy)}</td>
                    <td class="stat-cell">${formatStat(base.reload, max.reload)}</td>
                    <td class="price-cell">${weapon.price ? '$' + weapon.price.toLocaleString() : '<span class="price-free">Free</span>'}</td>
                    <td class="chapter-cell">${acq.chapter}</td>
                </tr>
            `}).join('');
        }

        function updateResultsCount(count) {
            document.getElementById('resultsCount').textContent =
                `Showing ${count} weapon${count !== 1 ? 's' : ''}`;
        }

        function sortWeapons(weapons, column, direction) {
            return [...weapons].sort((a, b) => {
                let valA, valB;

                // Helper to safely get stat value
                const getStat = (weapon, stat) => {
                    const max = weapon.maxStats?.[stat];
                    const base = weapon.baseStats?.[stat];
                    return max ?? base ?? 0;
                };

                switch (column) {
                    case 'name':
                        valA = a.name.toLowerCase();
                        valB = b.name.toLowerCase();
                        break;
                    case 'category':
                        valA = a.category.toLowerCase();
                        valB = b.category.toLowerCase();
                        break;
                    case 'damage':
                        valA = getStat(a, 'damage');
                        valB = getStat(b, 'damage');
                        break;
                    case 'range':
                        valA = getStat(a, 'range');
                        valB = getStat(b, 'range');
                        break;
                    case 'fireRate':
                        valA = getStat(a, 'fireRate');
                        valB = getStat(b, 'fireRate');
                        break;
                    case 'accuracy':
                        valA = getStat(a, 'accuracy');
                        valB = getStat(b, 'accuracy');
                        break;
                    case 'reload':
                        valA = getStat(a, 'reload');
                        valB = getStat(b, 'reload');
                        break;
                    case 'price':
                        valA = a.price || 0;
                        valB = b.price || 0;
                        break;
                    case 'chapter':
                        valA = getAcquisition(a).chapter;
                        valB = getAcquisition(b).chapter;
                        break;
                    default:
                        return 0;
                }

                if (valA < valB) return direction === 'asc' ? -1 : 1;
                if (valA > valB) return direction === 'asc' ? 1 : -1;
                return 0;
            });
        }

        function filterWeapons(weapons, query) {
            if (!query) return weapons;

            const lowerQuery = query.toLowerCase();
            return weapons.filter(weapon => {
                // Search all acquisition methods
                const acqs = Array.isArray(weapon.acquisition) ? weapon.acquisition : [weapon.acquisition];
                const acqMatch = acqs.some(acq =>
                    acq.location.toLowerCase().includes(lowerQuery) ||
                    acq.chapter.toLowerCase().includes(lowerQuery)
                );

                return weapon.name.toLowerCase().includes(lowerQuery) ||
                    weapon.category.toLowerCase().includes(lowerQuery) ||
                    acqMatch ||
                    (weapon.communityNotes && weapon.communityNotes.toLowerCase().includes(lowerQuery));
            });
        }

        function updateTable() {
            const query = document.getElementById('searchInput').value;
            let filtered = filterWeapons(weaponData, query);
            let sorted = sortWeapons(filtered, currentSort.column, currentSort.direction);
            renderTable(sorted);
            updateResultsCount(sorted.length);
        }

        function updateSortIndicators() {
            document.querySelectorAll('.weapon-table th').forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
                if (th.dataset.sort === currentSort.column) {
                    th.classList.add(currentSort.direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
                }
            });
        }

        // Event listeners
        document.getElementById('searchInput').addEventListener('input', updateTable);

        document.querySelectorAll('.weapon-table th[data-sort]').forEach(th => {
            th.addEventListener('click', () => {
                const column = th.dataset.sort;
                if (currentSort.column === column) {
                    // Toggle direction
                    currentSort.direction = currentSort.direction === 'desc' ? 'asc' : 'desc';
                } else {
                    currentSort.column = column;
                    // Stats: descending first (higher is better)
                    // Price and chapter: ascending first (lower is better)
                    const ascFirstColumns = ['price', 'chapter', 'name', 'category'];
                    currentSort.direction = ascFirstColumns.includes(column) ? 'asc' : 'desc';
                }
                updateSortIndicators();
                updateTable();
            });
        });

        // Initialize
        loadWeapons().then(() => {
            updateSortIndicators();
        });

        // Scroll shadow: hide when scrolled to end
        const scrollWrapper = document.getElementById('tableScrollWrapper');
        const outerWrapper = scrollWrapper.parentElement;
        scrollWrapper.addEventListener('scroll', () => {
            const isAtEnd = scrollWrapper.scrollLeft + scrollWrapper.clientWidth >= scrollWrapper.scrollWidth - 5;
            outerWrapper.classList.toggle('scrolled-end', isAtEnd);
        });
    </script>
</body>
</html>
