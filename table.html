<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Horses - RDR2 Companion</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rye&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="components.css">
    <style>
        .table-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* .back-link styles moved to components.css */

        .search-container {
            margin-bottom: 20px;
        }

        /* .search-input styles moved to components.css */

        /* .results-count styles moved to components.css */

        .horse-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-card);
            border-radius: 8px;
            overflow: hidden;
        }

        .horse-table th {
            background: var(--bg-elevated);
            color: var(--rust);
            font-family: 'Rye', cursive;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 12px 10px;
            text-align: left;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
            border-bottom: 2px solid var(--border-medium);
        }

        .horse-table th:hover {
            background: var(--bg-dark);
            color: var(--red-primary);
        }

        .horse-table th.sorted-asc::after {
            content: ' ▲';
            font-size: 0.7rem;
        }

        .horse-table th.sorted-desc::after {
            content: ' ▼';
            font-size: 0.7rem;
        }

        .horse-table td {
            padding: 12px 10px;
            border-bottom: 1px solid var(--border-subtle);
            color: var(--text-cream);
            font-size: 0.95rem;
            line-height: 1.4;
        }

        .horse-table tr:hover {
            background: var(--bg-elevated);
        }

        .horse-table tr:last-child td {
            border-bottom: none;
        }

        .horse-link {
            color: var(--rust);
            text-decoration: none;
            font-weight: 600;
        }

        .horse-link:hover {
            color: var(--red-primary);
            text-decoration: underline;
        }

        .stat-cell {
            text-align: center;
            font-family: 'Rye', cursive;
        }

        .stat-base {
            color: var(--text-muted);
        }

        .stat-max {
            color: var(--red-primary);
        }

        .category-badge {
            display: inline-block;
            background: var(--bg-dark);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .price-cell {
            color: var(--text-cream);
        }

        .price-free {
            color: var(--text-muted);
            font-style: italic;
        }

        .chapter-cell {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        @media (max-width: 900px) {
            .horse-table {
                font-size: 0.85rem;
            }

            .horse-table th,
            .horse-table td {
                padding: 8px 6px;
            }

            /* Mobile: horizontal scroll with sticky first column */
            .table-outer-wrapper {
                position: relative;
            }

            .table-scroll-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            /* Fade shadow on right edge to indicate more content */
            .table-outer-wrapper::after {
                content: '';
                position: absolute;
                right: 0;
                top: 0;
                bottom: 0;
                width: 30px;
                background: linear-gradient(to right, transparent, var(--bg-dark));
                pointer-events: none;
                z-index: 10;
                opacity: 1;
                transition: opacity 0.2s;
            }

            /* Hide shadow when scrolled to end */
            .table-outer-wrapper.scrolled-end::after {
                opacity: 0;
            }

            .horse-table {
                min-width: 800px;
                border-collapse: separate;
                border-spacing: 0;
                overflow: visible; /* Override hidden - required for sticky */
                border-radius: 0; /* Remove radius since we can't clip without overflow:hidden */
            }

            /* Sticky first column */
            .horse-table th:first-child,
            .horse-table td:first-child {
                position: sticky;
                left: 0;
                z-index: 2;
                background: var(--bg-elevated);
            }

            .horse-table td:first-child {
                background: var(--bg-card);
            }

            .horse-table tr:hover td:first-child {
                background: var(--bg-elevated);
            }
        }
    </style>
    <!-- Vercel Analytics -->
    <script defer src="/_vercel/insights/script.js"></script>
    <script src="components.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="utils.js"></script>
    <script src="app.js"></script>
</head>
<body>
    <div class="container table-container">
        <script>document.write(Components.header({backHref: "horses.html", backText: "Back to Horses", title: "All Horses", showAuth: true}))</script>

        <main>
            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" placeholder="Search by breed, coat, category, location..." autofocus>
            </div>

            <div id="resultsCount" class="results-count"></div>

            <div class="table-outer-wrapper">
                <div class="table-scroll-wrapper" id="tableScrollWrapper">
                    <table class="horse-table" id="horseTable">
                    <thead>
                        <tr>
                            <th data-sort="breed">Breed</th>
                            <th data-sort="coat">Coat</th>
                            <th data-sort="category">Category</th>
                            <th data-sort="health" class="stat-cell">Health</th>
                            <th data-sort="stamina" class="stat-cell">Stamina</th>
                            <th data-sort="speed" class="stat-cell">Speed</th>
                            <th data-sort="accel" class="stat-cell">Accel</th>
                            <th data-sort="handling">Handling</th>
                            <th data-sort="price">Price</th>
                            <th data-sort="chapter">Available</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="10" class="no-results">Loading horses...</td>
                        </tr>
                    </tbody>
                    </table>
                </div>
            </div>
        </main>

        <div data-component="footer"></div>
    </div>

    <script>
        // Use local variable to avoid collision with app.js global horseData
        let tableHorseData = [];
        let currentSort = { column: 'breed', direction: 'asc' };

        // Helper to get first acquisition (handles both array and object)
        function getAcquisition(horse) {
            return Array.isArray(horse.acquisition) ? horse.acquisition[0] : horse.acquisition;
        }

        async function loadHorses() {
            try {
                const response = await fetch('horses.json');
                const data = await response.json();
                tableHorseData = data.horses;
                renderTable(tableHorseData);
                updateResultsCount(tableHorseData.length);
            } catch (error) {
                console.error('Failed to load horses:', error);
                document.getElementById('tableBody').innerHTML =
                    '<tr><td colspan="10" class="no-results">Failed to load horse data</td></tr>';
            }
        }

        function renderTable(horses) {
            const tbody = document.getElementById('tableBody');

            if (horses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="no-results">No horses match your search</td></tr>';
                return;
            }

            tbody.innerHTML = horses.map(horse => `
                <tr>
                    <td><a href="${horse.detailUrl}" class="horse-link">${horse.breed}</a></td>
                    <td>${horse.coat}</td>
                    <td><span class="category-badge">${horse.category}</span></td>
                    <td class="stat-cell"><span class="stat-base">${horse.baseStats.health}</span>→<span class="stat-max">${horse.maxStats.health}</span></td>
                    <td class="stat-cell"><span class="stat-base">${horse.baseStats.stamina}</span>→<span class="stat-max">${horse.maxStats.stamina}</span></td>
                    <td class="stat-cell"><span class="stat-base">${horse.baseStats.speed}</span>→<span class="stat-max">${horse.maxStats.speed}</span></td>
                    <td class="stat-cell"><span class="stat-base">${horse.baseStats.acceleration}</span>→<span class="stat-max">${horse.maxStats.acceleration}</span></td>
                    <td>${horse.handling}</td>
                    <td class="price-cell">${horse.price ? '$' + horse.price.toLocaleString() : '<span class="price-free">Free</span>'}</td>
                    <td class="chapter-cell">${getAcquisition(horse).chapter}</td>
                </tr>
            `).join('');
        }

        function updateResultsCount(count) {
            document.getElementById('resultsCount').textContent =
                `Showing ${count} horse${count !== 1 ? 's' : ''}`;
        }

        function sortHorses(horses, column, direction) {
            return [...horses].sort((a, b) => {
                let valA, valB;

                switch (column) {
                    case 'breed':
                        valA = a.breed.toLowerCase();
                        valB = b.breed.toLowerCase();
                        break;
                    case 'coat':
                        valA = a.coat.toLowerCase();
                        valB = b.coat.toLowerCase();
                        break;
                    case 'category':
                        valA = a.category.toLowerCase();
                        valB = b.category.toLowerCase();
                        break;
                    case 'health':
                        valA = a.maxStats.health;
                        valB = b.maxStats.health;
                        break;
                    case 'stamina':
                        valA = a.maxStats.stamina;
                        valB = b.maxStats.stamina;
                        break;
                    case 'speed':
                        valA = a.maxStats.speed;
                        valB = b.maxStats.speed;
                        break;
                    case 'accel':
                        valA = a.maxStats.acceleration;
                        valB = b.maxStats.acceleration;
                        break;
                    case 'handling':
                        valA = a.handling.toLowerCase();
                        valB = b.handling.toLowerCase();
                        break;
                    case 'price':
                        valA = a.price || 0;
                        valB = b.price || 0;
                        break;
                    case 'chapter':
                        valA = getAcquisition(a).chapter;
                        valB = getAcquisition(b).chapter;
                        break;
                    default:
                        return 0;
                }

                if (valA < valB) return direction === 'asc' ? -1 : 1;
                if (valA > valB) return direction === 'asc' ? 1 : -1;
                return 0;
            });
        }

        function filterHorses(horses, query) {
            if (!query) return horses;

            const lowerQuery = query.toLowerCase();
            return horses.filter(horse => {
                // Search all acquisition methods
                const acqs = Array.isArray(horse.acquisition) ? horse.acquisition : [horse.acquisition];
                const acqMatch = acqs.some(acq =>
                    acq.location.toLowerCase().includes(lowerQuery) ||
                    acq.chapter.toLowerCase().includes(lowerQuery)
                );

                return horse.breed.toLowerCase().includes(lowerQuery) ||
                    horse.coat.toLowerCase().includes(lowerQuery) ||
                    horse.category.toLowerCase().includes(lowerQuery) ||
                    horse.handling.toLowerCase().includes(lowerQuery) ||
                    acqMatch ||
                    (horse.communityNotes && horse.communityNotes.toLowerCase().includes(lowerQuery));
            });
        }

        function updateTable() {
            const query = document.getElementById('searchInput').value;
            let filtered = filterHorses(tableHorseData, query);
            let sorted = sortHorses(filtered, currentSort.column, currentSort.direction);
            renderTable(sorted);
            updateResultsCount(sorted.length);
        }

        // Event listeners
        document.getElementById('searchInput').addEventListener('input', updateTable);

        // Initialize sort and scroll utilities
        const ascFirstColumns = ['price', 'chapter', 'breed', 'coat'];
        TableUtils.initSortListeners('.horse-table', currentSort, updateTable, ascFirstColumns);
        TableUtils.initScrollShadow('tableScrollWrapper');

        // Initialize
        loadHorses().then(() => {
            TableUtils.updateSortIndicators('.horse-table', currentSort);
        });
    </script>
</body>
</html>
